# 16. CQRS를 이용한 관심사 분리

## 6.1 CQRS 패턴

CQRS(command query responsibility separation) 패턴은 명령(커멘드(command))과 조회(쿼리(query))를 분리하여 성능과 확장성 및 보안성을 놓일 수 있도록 해주는 아키테처 패턴이다.

요구 사항이 복잡해질수록 도메인 모델 역시 복잡해진다.

데이터를 조회한 쪽에서는 현재의 복잡한 모델 구조의 데이터가 필요하지 않은 경우가 대부분이므로 조회 시의 모델과 데이터를 업데이트할 때의 모델을 다르게 가져가도록 하는 방식이다.

조회는 CRUD(create, read, update, delete)에서 read 동작을 담당하는 요청을 뜻한다.

리소스를 조회한 결과만을 반환하므로 시스템의 상태를 변경하지 않으며 부작용이 없다.

명령은 create, update, delete 요청과 같이 시스템의 상태를 변경한다.

![martinfowler-CQRS.png](./martinfowler-CQRS.png)

위 그림과 같이 마틴 파울러는 블로그에서 다음과 같은 경우에 CQRS를 사용하면 이점이 있다고 했다.

- **CQRS를 사용하면 몇 가지 복잡한 도메인을 다루기 더 쉬운 경우** : CQRS를 사용하면 복잡성이 추가되기 때문에 생산성이 감소하므로, 모델을 공유하는 것이 도메인을 다루기 더 쉬운지 면밀히 판단해야 한다.
    
    특히 시스템 전체가 아닌 **도메인 주도 설계(domain-driven design, DDD)에서 말하는 bounded context 내에서만 사용해야 한다.
    
- **고성능 처리가 필요한 애플리케이션을 다루는 경우** : CQRS를 사용하면 읽기 및 쓰기 작업에서 로드를 분리하여 각각을 독립적으로 확장할 수 있다.
    
    클라우드 데이터베이스를 사용한다면 손쉽게 읽기, 쓰기 DB를 분리할 수 있다.
    
    또 성능을 위해 쓰기는 RDB로, 읽기는 도큐먼트 DB를 사용하는 경우도 많다.
    
    애플리케이션에서 읽기와 쓰기 사이에 큰 성능차이가 있는 경우 CQRS를 쓰면 편리하다.
    
    또한 양쪽에 서로 다른 최적화 전략을 적용할 수 있다.
    

CQRS를 사용하면 자연스럽게 다른 아키텍처 패턴과 잘 어울리게 된다. 

- CRUD를 통해 상호작용하는 단일 표현(representation)에서 작업(task) 기반 UI로 쉽게 이동 가능하다.
    
    예를 들어, "ReservationStatus를 RESERVED로 설정" 이라는 명령을 '룸 예약'으로 변경하게 된다.
    
- 이벤트 기반 프로그래밍 모델과 잘 맞다
    
    이를 통해 이벤트 소싱을 쉽게 활용할 수 있다.
    
- 최종 일관성(eventually consistent)을 사용할 가능성이 높아진다.
- 도메인을 사용할 경우 업데이트할 때 많은 로직이 필요하므로 [EagerReadDerivation](https://martinfowler.com/bliki/EagerReadDerivation.html)을 사용하여 쿼리 측 모델을 단순화하는 것이 합리적일 수 있다.
- 쓰기 모델이 모든 업데이트에 대한 이벤트를 생성하는 경우, 읽기 모델을 별도로 구성하여 과도한 데이터베이스 상호작용을 피할 수 있다.
- CQRS는 복잡한 도메인을 다루고 DDD를 적용하는데 적합하다.

## 16.2 유저 서비스에CQRS 적용하기

지금까지 만든 조그만 유저 서비스는 회원가입, 로그인, 그리고 이메일을 전송하는 비즈니스 로직만을 가지고 있다.

물론 여기에 핵심 기능을 더 붙여가면서 서비스를 확장하겠지만 여전히 당분간 그 크기는 작을 것이다.

이렇게 작은 서비스에는 로직이 단순하고 변경이 생겨도 크게 영향을 끼치지 않는다.

하지만 서비스가 커질수록 변경 영향도는 점차 커지게 되고, 컨트롤러와 서비스, 영속화 및 도메인 레이어에서 주고받는 데이터가 복잡해질 뿐 아니라, 콘텍스트가 상이한 곳에서 모델을 그대로 전달하고 사용하는 경우가 발생한다.

당장은 CQRS를 적용하지 않아도 충분하지만 Nest에서 제공하는 간단한 CQRS모듈을 적용해보겠다.

[16.2 유저 서비스에CQRS 적용하기](https://www.notion.so/16-2-CQRS-8c7ff094c20e47c1a5fd3604c1487010?pvs=21)