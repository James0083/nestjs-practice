# 9. ìš”ì²­ ì²˜ë¦¬ ì „ì— ë¶€ê°€ ê¸°ëŠ¥ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•œ ë¯¸ë“¤ì›¨ì–´

[Documentation | NestJS - A progressive Node.js framework](https://docs.nestjs.com/middleware)

## 9.1 ë¯¸ë“¤ì›¨ì–´

ì›¹ ê°œë°œì—ì„œ ì¼ë°˜ì ìœ¼ë¡œ ë¯¸ë“¤ì›¨ì–´(middleware)ë¼ í•¨ì€ ë¼ìš°íŠ¸ í•¸ë“¤ëŸ¬ê°€ í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ì„ ì²˜ë¦¬í•˜ê¸° ì „ì— ìˆ˜í–‰ë˜ëŠ” ì»´í¬ë„ŒíŠ¸ë¥¼ ë§í•œë‹¤. 

![Middlewares_1.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/380da689-6e0b-4496-b9c4-07070d4b592a/bc554f9b-2bad-491b-95fe-a7d52f1a8f16/Middlewares_1.png)

Nestì˜ ë¯¸ë“¤ì›¨ì–´ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ Expressì˜ ë¯¸ë“¤ì›¨ì–´ì™€ ë™ì¼í•˜ë‹¤.

[Expressë¬¸ì„œ](https://expressjs.com/en/guide/using-middleware.html)ì—ëŠ” ë¯¸ë“¤ì›¨ì–´ê°€ ë‹¤ìŒê³¼ ê°™ì€ ë™ì‘ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆë‹¤ê³  ê¸°ìˆ ë˜ì–´ ìˆë‹¤. 

- ì–´ë–¤ í˜•íƒœì˜ ì½”ë“œë¼ë„ ìˆ˜í–‰í•  ìˆ˜ ìˆë‹¤.
- ìš”ì²­ê³¼ ì‘ë‹µì— ë³€í˜•ì„ ê°€í•  ìˆ˜ ìˆë‹¤.
- ìš”ì²­/ì‘ë‹µ ì£¼ê¸°ë¥¼ ëë‚¼ ìˆ˜ ìˆë‹¤.
- ì—¬ëŸ¬ ê°œì˜ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‚¬ìš©í•œë‹¤ë©´ next()ë¡œ í˜¸ì¶œ ìŠ¤íƒìƒ ë‹¤ìŒ ë¯¸ë“¤ì›¨ì–´ì— ì œì–´ê¶Œì„ ì „ë‹¬í•œë‹¤.

ìš”ì²­/ì‘ë‹µ ì£¼ê¸°ë¥¼ ëë‚¸ë‹¤ëŠ” ê²ƒì€ ì‘ë‹µì„ ë³´ë‚´ê±°ë‚˜ ì—ëŸ¬ ì²˜ë¦¬ë¥¼ í•´ì•¼ í•œë‹¤ëŠ” ëœ»ì´ë‹¤. 

ë§Œì•½ í˜„ì¬ ë¯¸ë“¤ì›¨ì–´ê°€ ì‘ë‹µ ì£¼ê¸°ë¥¼ ëë‚´ì§€ ì•Šì„ ê²ƒì´ë¼ë©´ ë°˜ë“œì‹œ next()ë¥¼ í˜¸ì¶œí•´ì•¼ í•œë‹¤. 

ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ ë”ì´ìƒ ì•„ë¬´ê²ƒë„ í•  ìˆ˜ ì—†ëŠ” ìƒíƒœ(hanging)ê°€ ëœë‹¤.

ë¯¸ë“¤ì›¨ì–´ì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì€ ì‘ì—…ë“¤ì„ ìˆ˜í–‰í•œë‹¤.

- **ì¿ í‚¤ íŒŒì‹±** : ì¿ í‚¤ë¥¼ íŒŒì‹±í•˜ì—¬ ì‚¬ìš©í•˜ê¸° ì‰¬ìš´ ë°ì´í„° êµ¬ì¡°ë¡œ ë³€ê²½í•œë‹¤. ì´ë¥¼ ì´ìš©í•˜ë©´ ë¼ìš°í„° í•¸ë“¤ëŸ¬ê°€ ë§¤ë²ˆ ì¿ í‚¤ë¥¼ íŒŒì‹±í•  í•„ìš”ê°€ ì—†ë‹¤.
- **ì„¸ì…˜ ê´€ë¦¬** : ì„¸ì…˜ ì¿ í‚¤ë¥¼ ì°¾ê³ , í•´ë‹¹ ì¿ í‚¤ì— ëŒ€í•œ ì„¸ì…˜ì˜ ìƒíƒœë¥¼ ì¡°íšŒí•´ì„œ ìš”ì²­ì— ì„¸ì…˜ ì •ë³´ë¥¼ ì¶”ê°€í•œë‹¤. ì´ë¥¼ í†µí•´ ë‹¤ë¥¸ í•¸ë“¤ëŸ¬ê°€ ì„¸ì…˜ ê°ì²´ë¥¼ ì´ìš©í•  ìˆ˜ ìˆê²Œ í•´ì¤€ë‹¤.
- ******************ì¸ì¦/ì¸ê°€****************** : ì‚¬ìš©ìê°€ ì„œë¹„ìŠ¤ì— ì ‘ê·¼ ê°€ëŠ¥í•œ ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸í•œë‹¤. ë‹¨, NestëŠ” ì¸ê°€ë¥¼ êµ¬í˜„í•  ë•Œ ê°€ë“œë¥¼ ì´ìš©í•˜ë„ë¡ ê¶Œì¥í•œë‹¤.
- **********************ë³¸ë¬¸ íŒŒì‹±********************** : ë³¸ë¬¸ì€ POST/PUT ìš”ì²­ìœ¼ë¡œ ë“¤ì–´ì˜¤ëŠ” JSOM íƒ€ì…ë¿ ì•„ë‹ˆë¼ íŒŒì¼ ìŠ¤íŠ¸ë¦¼ê³¼ ê°™ì€ ë°ì´í„°ë„ ìˆë‹¤. ì´ ë°ì´í„°ë¥¼ ìœ í˜•ì— ë”°ë¼ ì½ê³  í•´ì„í•œ ë‹¤ìŒ ë§¤ê°œë³€ìˆ˜ì— ë„£ëŠ” ì‘ì—…ì„ í•œë‹¤. ì•ì„œ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ë‹¤ë£° ë•Œ ë´¤ë˜ ë³¸ë¬¸ì€ ì´ë ‡ê²Œ ë¶„ì„ëœ ê²°ê³¼ê°€ í¬í•¨ë˜ì–´ ìˆë‹¤.

ê·¸ ì™¸ ì›í•˜ëŠ” ê¸°ëŠ¥ì´ ìˆë‹¤ë©´ ì§ì ‘ êµ¬í˜„ë„ ê°€ëŠ¥í•˜ë‹¤. 

í•„ìê°€ ì†í•´ìˆëŠ” íšŒì‚¬ì—ì„œëŠ” ë°ì´í„°ë² ì´ìŠ¤ íŠ¸ëœì­ì…˜ì´ í•„ìš”í•œ ìš”ì²­ì´ ìˆì„ ë•Œë§ˆë‹¤ íŠ¸ëœì­ì…˜ì„ ê±¸ê³  ë™ì‘ì„ ìˆ˜í–‰í•œ í›„ ì»¤ë°‹í•˜ëŠ” ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‘ì„±í•´ì„œ ì‚¬ìš©í•˜ê³  ìˆë‹¤. 

ì»¤ìŠ¤í…€ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì˜ ë§Œë“¤ë©´ ë„ë©”ì¸ ê´€ì‹¬ì‚¬ë¥¼ ì§‘ì¤‘í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‘ì„±í•  ìˆ˜ ìˆë‹¤. 

ë¯¸ë“¤ì›¨ì–´ì™€ ë¹„ìŠ·í•œ ê°œë…ìœ¼ë¡œ ì¸í„°ì…‰í„°ê°€ ìˆë‹¤. ì¸í„°ì…‰í„°ì— ëŒ€í•´ì„ ëŠ 13ì¥ì—ì„œ ì„¤ëª…í•œë‹¤. 

## 9.2 Loggerë¯¸ë“¤ì›¨ì–´

ë¯¸ë“¤ì›¨ì–´ëŠ” í•¨ìˆ˜ë¡œ ì‘ì„±í•˜ê±°ë‚˜ NestMiddleware ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œ í´ë˜ìŠ¤ë¡œ ì‘ì„±í•  ìˆ˜ ìˆë‹¤. 

ë“¤ì–´ì˜¨ ìš”ì²­ì— í¬í•¨ëœ ì •ë³´ë¥¼ ë¡œê¹…í•˜ê¸° ìœ„í•œ Loggerë¥¼ ë¯¸ë“¤ì›¨ì–´ë¡œ êµ¬í˜„í•´ë³´ì.

```tsx
//logger.middleware.ts
import { Injectable, NestMiddleware } from '@nestjs/common';
import { Request, Response, NextFunction } from 'express';

@Injectable()
export class LoggerMiddleware implements NestMiddleware {
  use(req: Request, res: Response, next: NextFunction) {
    console.log('Request...');
    next();
  }
}
```

ë¯¸ë“¤ì›¨ì–´ë¥¼ ëª¨ë“ˆì— í¬í•¨ì‹œí‚¤ê¸° ìœ„í•´ì„œëŠ” í•´ë‹¹ ëª¨ë“ˆì€ NestModuleì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•´ì•¼ í•œë‹¤.

NestModuleì— ì„ ì–¸ëœ configureí•¨ìˆ˜ë¥¼ í†µí•´ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì„¤ì •í•œë‹¤.

```tsx
//app.module.ts
import { MiddlewareConsumer, Module, NestModule, RequestMethod } from '@nestjs/common';
import { LoggerMiddleware } from './logger/logger.middleware';
import { UsersModule } from './users/users.module';

@Module({
  imports: [UsersModule],
})
export class AppModule implements NestModule {
  configure(consumer: MiddlewareConsumer): any {
    consumer
      .apply(LoggerMiddleware)
      .forRoutes('/users')
  }
}
```

/users ê²½ë¡œë¡œ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì„ ìˆ˜í–‰í•´ë³´ë©´ ì½˜ì†”ì— â€˜Requestâ€¦â€™ì´ ì°íˆëŠ”ê±¸ í™•ì¸í•  ìˆ˜ ìˆë‹¤. 

## 9.3 MiddlewareConsumer

ì´ì „ ì½”ë“œì—ì„œ configure ë©”ì„œë“œì— ì¸ìˆ˜ë¡œ ì „ë‹¬ëœ MiddlewareConsumerê°ì²´ë¥¼ ì´ìš©í•´ì„œ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì–´ë””ì— ì ìš©í• ì§€ ê´€ë¦¬í•  ìˆ˜ ìˆë‹¤. 

applyë©”ì„œë“œì˜ ì›í˜•ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

```tsx
apply(...middleware: (Type<any> | Function)[]): MiddlewareConfigProxy;
```

apply ë©”ì„œë“œì— ë¯¸ë“¤ì›¨ì–´ í•¨ìˆ˜ ë˜ëŠ” í´ë˜ìŠ¤ë¥¼ ì½¤ë§ˆë¡œ ë‚˜ì—´í•˜ë©´ ëœë‹¤. 

ì´ë•Œ ë¯¸ë“¤ì›¨ì–´ê°€ ë‚˜ì—´ëœ ìˆ˜ì„œëŒ€ë¡œ ì ìš©ëœë‹¤. 

ë§Œì•½ Logger2Middlewareë¼ëŠ” ë¯¸ë“¤ì›¨ì–´ê°€ í•˜ë‚˜ ë” ìˆë‹¤ê³  í•˜ê³ 

```tsx
//logger2.middleware.ts
import { Injectable, NestMiddleware } from '@nestjs/common';
import { Request, Response, NextFunction } from 'express';

@Injectable()
export class Logger2Middleware implements NestMiddleware {
  use(req: Request, res: Response, next: NextFunction) {
    console.log('Request2...')
    next();
  }
}
```

2ê°œì˜ ë¯¸ë“¤ì›¨ì–´ë¥¼ ëª¨ë‘ ì ìš©í•œë‹¤ë©´ 

```tsx
import { MiddlewareConsumer, Module, NestModule, RequestMethod } from '@nestjs/common';
import { LoggerMiddleware } from './logger/logger.middleware';
import { Logger2Middleware } from './logger/logger2.middleware';
import { UsersModule } from './users/users.module';

@Module({
  imports: [UsersModule],
})
export class AppModule implements NestModule {
  configure(consumer: MiddlewareConsumer): any {
    consumer
      .apply(LoggerMiddleware, Logger2Middleware)
      .forRoutes('/users')
  }
}
```

/users ê²½ë¡œì˜ ìš”ì²­ì— ë¡œê·¸ê°€ 2ê°œ ì°íˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤. 

forRoutesë©”ì„œë“œì˜ ì›í˜•ë„ ì‚´í´ë³´ì. 

forRouteëŠ” apply í•¨ìˆ˜ì˜ ë¦¬í„´ íƒ€ì…ì¸ MiddlewareConfigProxyì— ì •ì˜ë˜ì–´ ìˆë‹¤. 

```tsx
import { Type } from '../type.interface';
import { RouteInfo } from './middleware-configuration.interface';
import { MiddlewareConsumer } from './middleware-consumer.interface';
export interface MiddlewareConfigProxy {
    exclude(...routes: (string | RouteInfo)[]): MiddlewareConfigProxy;
    forRoutes(...routes: (string | Type<any> | RouteInfo)[]): MiddlewareConsumer;
}
```

ì˜ˆì œì—ì„œ ë´¤ë“¯ forRoutesì˜ ì¸ìˆ˜ë¡œ ë¬¸ìì—´ í˜•ì‹ì˜ ê²½ë¡œë¥¼ ì§ì ‘ ì£¼ê±°ë‚˜, ì»¨íŠ¸ë¡¤ëŸ¬ í´ë˜ìŠ¤ ì´ë¦„ì„ ì£¼ì–´ë„ ì™¸ê³ ,  RouteInfo ê°ì²´ë¥¼ ë„˜ê¸¸ ìˆ˜ë„ ìˆë‹¤. 

ë³´í†µì€ ì»¨íŠ¸ë¡¤ëŸ¬ í´ë˜ìŠ¤ë¥¼ ì£¼ì–´ ë™ì‘í•˜ë„ë¡ í•œë‹¤. 

```tsx
import { MiddlewareConsumer, Module, NestModule, RequestMethod } from '@nestjs/common';
import { LoggerMiddleware } from './logger/logger.middleware';
import { Logger2Middleware } from './logger/logger2.middleware';
import { UsersController } from './users/users.controller';
import { UsersModule } from './users/users.module';

@Module({
  imports: [UsersModule],
})
export class AppModule implements NestModule {
  configure(consumer: MiddlewareConsumer): any {
    consumer
      .apply(LoggerMiddleware, Logger2Middleware)
      .forRoutes(UsersController)
  }
}
```

ë¯¸ë“¤ì›¨ì–´ì—ì„œ nest() í•¨ìˆ˜ í˜¸ì¶œë¶€ë¥¼ ì£¼ì„ìœ¼ë¡œ ë§‰ì•„ì„œ í–‰ì´ ê±¸ë¦¬ëŠ”ì§€ í™•ì¸í•´ë³´ì.

ë˜í•œ use í•¨ìˆ˜ ë‚´ì—ì„œ ì‘ë‹µì„ ë°”ë¡œ ì£¼ë„ë¡ í•˜ë©´ ë‹¤ìŒ ë¯¸ë“¤ì›¨ì–´ê°€ ë™ì‘í•˜ì§€ ì•ŠëŠ” ê²ƒë„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. 

```tsx
import { Injectable, NestMiddleware } from '@nestjs/common';
import { Request, Response, NextFunction } from 'express';

@Injectable()
export class LoggerMiddleware implements NestMiddleware {
  use(req: Request, res: Response, next: NextFunction) {
    console.log('Request...');
    res.send('DONE'); // ì´ ë¼ì¸ ì£¼ì„ì„ í’€ê³  next()ë¥¼ ì£¼ì„ìœ¼ë¡œ ë§‰ìœ¼ë©´ ë¯¸ë“¤ì›¨ì–´ ìˆ˜í–‰ì„ ì¤‘ë‹¨í•œë‹¤.
    // next();  // res.sendì™€ ì´ ë¼ì¸ì„ ì£¼ì„ìœ¼ë¡œ ë§‰ìœ¼ë©´ í–‰ì´ ê±¸ë¦°ë‹¤.
  }
}
```

exclude í•¨ìˆ˜ëŠ” ì˜ˆìƒí•˜ë“¯ì´ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì ìš©í•˜ì§€ ì•Šì„ ë¼ìš°íŒ… ê²½ë¡œë¥¼ ì„¤ì •í•œë‹¤. 

```tsx
import { MiddlewareConsumer, Module, NestModule, RequestMethod } from '@nestjs/common';
import { LoggerMiddleware } from './logger/logger.middleware';
import { Logger2Middleware } from './logger/logger2.middleware';
import { UsersController } from './users/users.controller';
import { UsersModule } from './users/users.module';

@Module({
  imports: [UsersModule],
})
export class AppModule implements NestModule {
  configure(consumer: MiddlewareConsumer): any {
    consumer
      .apply(LoggerMiddleware, Logger2Middleware)
      .exclude({ path: 'users', method: RequestMethod.GET },)  //1
      .forRoutes(UsersController)
  }
}
```

> 1) /users ê²½ë¡œë¡œ ì „ë‹¬ëœ GET ìš”ì²­ì¼ ë•ŒëŠ” LoggerMiddleware, Logger2Middlewareê°€ ë¬´ì‹œëœë‹¤.
> 

## 9.4 ì „ì—­ìœ¼ë¡œ ì ìš©í•˜ê¸°

ì§€ê¸ˆê¹Œì§€ëŠ” íŠ¹ì • ëª¨ë“ˆì— ë¯¸ë“¤ì›¨ì–´ë¥¼ ì ìš©í•˜ëŠ” ë°©ë²•ì´ë‹¤.

ë¯¸ë“¤ì›¨ì–´ë¥¼ ëª¨ë“  ëª¨ë“ˆì— ì ìš©í•˜ë ¤ë©´ main.tsë¥¼ ìˆ˜ì •í•´ì•¼í•œë‹¤.

NestFactory.createë¡œ ë§Œë“  ì•±ì€ INestApplication íƒ€ì…ì„ ê°€ì§€ê³  ìˆëŠ”ë°, ì—¬ê¸°ì— ì •ì˜ëœ use() ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì„¤ì •í•œë‹¤. 

í•˜ì§€ë§Œ use() ë©”ì„œë“œëŠ” í´ë˜ìŠ¤ë¥¼ ì¸ìˆ˜ë¡œ ë°›ì„ ìˆ˜ ì—†ë‹¤. 

ë”°ë¼ì„œ í•¨ìˆ˜ë¡œ ì •ì˜ëœ ë¯¸ë“¤ì›¨ì–´ë¥¼ ë‹¤ì‹œ ë§Œë“¤ì–´ì•¼ í•œë‹¤. 

```tsx
import { Request, Response, NextFunction } from 'express';

export function logger3(req: Request, res: Response, next: NextFunction) {
  console.log(`Request3...`);
  next();
};
```

ê·¸ë¦¬ê³  main.tsì— ì ìš©

```tsx
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { logger3 } from './logger/logger3.middleware';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  app.use(logger3);
  await app.listen(3000);
}
bootstrap();
```

exclude ìš”ì²­ì„ í’€ê³  ìš”ì²­ì„ ë³´ë‚´ë©´ logger3 ë¯¸ë“¤ì›¨ì–´ê°€ ë¨¼ì € ì ìš©ë˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤. 

```bash
...
[Nest] 62352  - 2023. 10. 27. ì˜¤í›„ 5:40:55     LOG [RouterExplorer] Mapped {/users/:id, GET} route +1ms
[Nest] 62352  - 2023. 10. 27. ì˜¤í›„ 5:40:55     LOG [RouterExplorer] Mapped {/users/:id, PATCH} route +0ms
[Nest] 62352  - 2023. 10. 27. ì˜¤í›„ 5:40:55     LOG [RouterExplorer] Mapped {/users/:id, DELETE} route +0ms
[Nest] 62352  - 2023. 10. 27. ì˜¤í›„ 5:40:55     LOG [NestApplication] Nest application successfully started +2ms
Request3...
Request...
Request2...
```

<aside>
ğŸ’¡ í•¨ìˆ˜ë¡œ ë§Œë“  ë¯¸ë“¤ì›¨ì–´ì˜ ë‹¨ì ì€ DI ì»¨í…Œì´ë„ˆë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤ëŠ” ê²ƒì´ë‹¤. 
ì¦‰, í”„ë¡œë°”ì´ë”ë¥¼ ì£¼ì…ë°›ì•„ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤.

</aside>

ìœ ì € ì„œë¹„ìŠ¤ì—ì„œëŠ” ë”±íˆ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì ìš©í•  ê²Œ ì—†ë‹¤.