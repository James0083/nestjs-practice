# 13. μΈν„°μ…‰ν„°λ΅ μ”μ²­κ³Ό μ‘λ‹µμ„ μ…λ§›μ— λ§κ² λ°”κΎΈκΈ°

## 13.1 μΈν„°μ…‰ν„°

μΈν„°μ…‰ν„°(interceptor)λ” μ”μ²­κ³Ό μ‘λ‹µμ„ κ°€λ΅μ±„μ„ λ³€ν•μ„ κ°€ν•  μ μλ” μ»΄ν¬λ„νΈμ΄λ‹¤. 

![Interceptors_1.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/380da689-6e0b-4496-b9c4-07070d4b592a/43325a49-9ede-4e9e-b881-1f5a87575df3/Interceptors_1.png)

μΈν„°μ…‰ν„°λ” κ΄€μ  μ§€ν–¥ ν”„λ΅κ·Έλλ°μ—μ„ μν–¥μ„ λ§μ΄ λ°›μ•λ‹¤. 

μΈν„°μ…‰ν„°λ¥Ό μ΄μ©ν•λ©΄ λ‹¤μκ³Ό κ°™μ€ κΈ°λ¥μ„ μν–‰ν•  μ μ΄μ‹Ώ. 

- λ©”μ„λ“ μ‹¤ν–‰ μ „/ν›„ μ¶”κ°€ λ΅μ§μ„ λ°”μΈλ”©
- ν•¨μμ—μ„ λ°ν™λ κ²°κ³Όλ¥Ό λ³€ν™
- ν•¨μμ—μ„ λμ Έμ§„ μμ™Έλ¥Ό λ³€ν™
- κΈ°λ³Έ κΈ°λ¥μ λ™μ‘μ„ ν™•μ¥
- νΉμ • μ΅°κ±΄μ— λ”°λΌ κΈ°λ¥μ„ μ™„μ „ν μ¬μ •μ(μ: μΊμ‹±)

μΈν„°μ…‰ν„°λ” 9μ¥μ—μ„ μ„¤λ…ν• λ―Έλ“¤μ›¨μ–΄μ™€ μν–‰ν•λ” μΌμ΄ λΉ„μ·ν•μ§€λ§, μν–‰ μ‹μ μ— μ°¨μ΄κ°€ μλ‹¤. 

**λ―Έλ“¤μ›¨μ–΄**λ” **μ”μ²­μ΄ λΌμ°νΈ ν•Έλ“¤λ¬λ΅ μ „λ‹¬λκΈ° μ „μ— λ™μ‘**ν•λ©°, **μΈν„°μ…‰ν„°**λ” **μ”μ²­μ— λ€ν• λΌμ°νΈ ν•Έλ“¤λ¬μ μ²λ¦¬ μ „/ν›„ νΈμ¶**λμ–΄ μ”μ²­κ³Ό μ‘λ‹µμ„ λ‹¤λ£° μ μλ‹¤.

λ **λ―Έλ“¤μ›¨μ–΄**λ” **μ—¬λ¬ κ°μ λ―Έλ“¤μ›¨μ–΄λ¥Ό μ΅°ν•©ν•μ—¬ κ°κΈ° λ‹¤λ¥Έ λ©μ μ„ κ°€μ§„ λ―Έλ“¤μ›¨μ–΄ λ΅μ§μ„ μν–‰ν•  μ μ**λ‹¤.

9μ¥μ—μ„ μ„¤λ…ν–λ“―μ΄ μ–΄λ–¤ λ―Έλ“¤μ›¨μ–΄κ°€ λ‹¤μ λ―Έλ“¤μ›¨μ–΄μ— μ μ–΄κ¶μ„ λ„κΈ°μ§€ μ•κ³  μ”μ²­/μ‘λ‹µ μ£ΌκΈ°λ¥Ό λλ‚΄λ” μΌλ„ κ°€λ¥ν•λ‹¤.

μΈν„°μ…‰ν„°μ λ‚΄λ¶€ κµ¬ν„μ„ λ“¤μ—¬λ‹¤λ³΄κΈ° μ „μ— μΈν„°μ…‰ν„°λ¥Ό ν™μ©ν•λ” λ°©λ²•μ„ λ¨Όμ € λ³΄λ©΄,

**λΌμ°νΈ ν•Έλ“¤λ¬κ°€ μ”μ²­μ„ μ²λ¦¬ν•κΈ° μ „ν›„μ— μ–΄λ–¤ λ΅κ·Έλ¥Ό μ²λ¦¬ν•κΈ° μ „ν›„μ— μ–΄λ–¤ λ΅κ·Έλ¥Ό λ‚¨κΈ°κ³  μ‹¶λ‹¤λ” μ”κµ¬ μ‚¬ν•­**μ΄ μλ‹¤κ³  ν•μ.

μ΄λ¥Ό μ„ν•΄ LoggingInterceptorλ¥Ό λ§λ“¤μ–΄λ³΄μ.

```tsx
import { Injectable, NestInterceptor, ExecutionContext, CallHandler } from '@nestjs/common';
import { Observable } from 'rxjs';
import { tap } from 'rxjs/operators';

@Injectable()
export class LoggingInterceptor implements NestInterceptor {  //1
  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {  //2
    console.log('Before...');  //3

    const now = Date.now();
    return next
      .handle()
      .pipe(
        tap(() => console.log(`After... ${Date.now() - now}ms`)),  //4
      );
  }
}
```

> 1) μΈν„°μ…‰ν„°λ” @nestjs/common ν¨ν‚¤μ§€μ—μ„ μ κ³µν•λ” NestInterceptor μΈν„°νμ΄μ¤λ¥Ό κµ¬ν„ν• ν΄λμ¤μ΄λ‹¤.
> 
> 
> 2) NestInterceptor μΈν„°νμ΄μ¤μ intercept ν•¨μλ¥Ό κµ¬ν„ν•΄μ•Ό ν•λ‹¤.
> 
> 3) μ”μ²­μ΄ μ „λ‹¬λκΈ° μ „ λ΅κ·Έλ¥Ό μ¶λ ¥ν•λ‹¤.
> 
> 4) μ”μ²­μ„ μ²λ¦¬ν• ν›„ λ΅κ·Έλ¥Ό μ¶λ ¥ν•λ‹¤.
> 

μΈν„°μ…‰νΈλ¥Ό μ μ©.

νΉμ • μ»¨ν¬λ„νΈμ™€ μ μ‚¬ν• λ°©μ‹μΌλ΅ μ μ©ν•  μ μλ‹¤. 

νΉμ • μ»¨νΈλ΅¤λ¬λ‚ λ©”λ“μ— μ μ©ν•κ³  μ‹¶λ‹¤λ©΄ @UseInterceptors()λ¥Ό μ΄μ©ν•λ©΄ λλ‹¤.μ—¬κΈ°μ„λ” μ „μ—­μΌλ΅ μ μ©ν•΄λ³΄μ.

```tsx
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { LoggingInterceptor } from './logging.interceptor';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  app.useGlobalInterceptors(
    new LoggingInterceptor(),
  );
  await app.listen(3000);
}
bootstrap();
```

μ–΄λ–¤ μ”μ²­μ„ λ³΄λ‚΄λ©΄ μ„λ²„ μ½μ†”μ— λ΅κ·Έκ°€ μ°νλ” κ²ƒμ„ λ³Ό μ μλ‹¤. 

![α„‹α…µα„†α…µα„α…µ 2023. 10. 31. α„‹α…©α„’α…® 4.14.jpeg](https://prod-files-secure.s3.us-west-2.amazonaws.com/380da689-6e0b-4496-b9c4-07070d4b592a/22c5f50f-d9ff-4e71-8e99-d44985a36070/%E1%84%8B%E1%85%B5%E1%84%86%E1%85%B5%E1%84%8C%E1%85%B5_2023._10._31._%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_4.14.jpeg)

NestInterceptorμ μ •μλ¥Ό μμ„Έν μ‚΄ν΄λ³΄μ

```tsx
export interface NestInterceptor<T = any, R = any> {
    intercept(context: ExecutionContext, next: CallHandler<T>): Observable<R> | Promise<Observable<R>>;
}

export interface CallHandler<T = any> {
    handle(): Observable<T>;
}
```

κµ¬ν„ν•΄μ•Ό ν•λ” interceptμ— μ „λ‹¬λλ” μΈμκ°€ 2κ°μλ‹¤. 

ExecutionContextλ” 10μ¥μ—μ„ μ„¤λ…ν–λ κ²ƒκ³Ό λ™μΌν• μ½ν…μ¤νΈμ΄λ‹¤. 

λ‘ λ²μ§Έ μΈμλ” CallHandlerμΈλ°, μ΄ μΈν„°νμ΄μ¤λ” handle() λ©”μ„λ“λ¥Ό κµ¬ν„ν•΄μ•Ό ν•λ‹¤. 

handle() λ©”μ„λ“λ” λΌμ°νΈ ν•Έλ“¤λ¬μ—μ„ μ „λ‹¬λ μ‘λ‹µ μ¤νΈλ¦Όμ„ λλ ¤μ£Όκ³  RxJSμ Observableλ΅ κµ¬ν„λμ–΄ μλ‹¤. 

λ§μ•½ μΈν„°μ…‰ν„°μ—μ„ ν•Έλ“¤λ¬κ°€ μ κ³µν•λ” handle()λ©”μ„λ“λ¥Ό νΈμ¶ν•μ§€ μ•μΌλ©΄ λΌμ°ν„° ν•Έλ“¤λ¬κ°€ λ™μ‘μ„ ν•μ§€ μ•λ”λ‹¤. 

handle()μ„ νΈμ¶ν•κ³  Observableμ„ μμ‹ ν• ν›„μ— μ‘λ‹µ μ¤νΈλ¦Όμ— μ¶”κ°€ μ‘μ—…μ„ μν–‰ν•  μ μλ” κ²ƒμ΄λ‹¤. 

(LoggingInterceptor κµ¬ν„μ—μ„ λ΄¤λ κ²ƒμ²λΌ.)

μ‘λ‹µμ„ λ‹¤λ£¨λ” λ°©λ²•μ€ RxJSμ—μ„ μ κ³µν•λ” μ—¬λ¬κ°€μ§€ λ©”μ„λ“λ΅ κµ¬ν„μ΄ κ°€λ¥ν•λ‹¤. 

<aside>
π’΅ RxJSλ” λ‹¤λ¥Έ μλ£ μ°Έκ³ 

</aside>

[μ²« λ²μ§Έ μ](https://www.notion.so/NestJS-eec020bb6f684e4da16d67270939e1c7?pvs=21)μ—μ„λ” tap()μ„ μ‚¬μ©ν–λ‹¤. 

## 13.2 μ‘λ‹µκ³Ό μμ™Έ λ§¤ν•‘

μ•μ—μ„ μΈν„°μ…‰ν„°λ¥Ό ν†µν•΄ μ‘λ‹µκ³Ό λ°μƒν• μμ™Έλ¥Ό μ΅μ•„ λ³€ν•μ„ κ°€ν•  μ μλ‹¤κ³  ν–λ‹¤.

κ°κ°μ— λ€ν• κ°„λ‹¨ν• μΈν„°μ…‰ν„°λ¥Ό μλ¥Ό λ“¤μ–΄ μ‚΄ν΄λ³΄κ² λ‹¤.

λ¨Όμ € μ „λ‹¬λ°›μ€ μ‘λ‹µμ— λ©΄ν•μ„ κ°€ν•΄λ³΄μ.

**λΌμ°ν„° ν•Έλ“¤λ¬μ—μ„ μ „λ‹¬ν• μ‘λ‹µμ„ κ°μ²΄λ΅ κ°μ‹Έμ„ μ „λ‹¬**ν•λ„λ΅ ν•λ” TransformInterceptorλ¥Ό λ§λ“¤μ—λ‹¤.

```tsx
import { CallHandler, ExecutionContext, Injectable, NestInterceptor } from '@nestjs/common';
import { Observable } from 'rxjs';
import { map } from 'rxjs/operators';

export interface Response<T> {
  data: T;
}

@Injectable()
export class TransformInterceptor<T> implements NestInterceptor<T, Response<T>> {
  intercept(context: ExecutionContext, next: CallHandler): Observable<Response<T>> {
    return next
      .handle()
      .pipe(map(data => {
        return { data }
      }));
  }
}
```

TransformInterceptorλ” LoggingInterceptorμ™€ λ‹¤λ¥΄κ² GenericμΌλ΅ νƒ€μ… Tλ¥Ό μ„ μ–Έν•κ³  μλ‹¤.

NestInterceptorμΈν„°νμ΄μ¤μ μ •μλ¥Ό λ³΄λ©΄ GenericμΌλ΅ T, R νƒ€μ… 2κ°λ¥Ό μ„ μ–Έν•λ„λ΅ λμ–΄μλ‹¤.

μ‚¬μ‹¤ λ‘ λ‹¤ κΈ°λ³Έμ΄ anyνƒ€μ…μ΄κΈ° λ•λ¬Έμ— μ–΄λ–¤ νƒ€μ…μ΄ μ™€λ„ μƒκ΄€μ—†λ‹¤.

Tλ” μ‘λ‹µ μ¤νΈλ¦Όμ„ μ§€μ›ν•λ” Observable νƒ€μ…μ΄μ–΄μ•Ό ν•κ³ , Rμ€ μ‘λ‹µμ κ°’μ„ Observableλ΅ κ°μ‹Ό νƒ€μ…μ„ μ •ν•΄μ¤μ•Ό ν•λ‹¤.

νƒ€μ…μ¤ν¬λ¦½νΈλ¥Ό μ‚¬μ©ν•λ” κΉ€μ— νƒ€μ…μ„ λ…ν™•ν μ§€μ •ν•΄μ£Όλ©΄ λ” μ•μ „ν•κ² μ½”λ”©ν•  μ μλ‹¤.

TransformInterceptorμ μλ΅ λ‹¤μ‹ λμ•„κ°€λ©΄ Tλ” anyνƒ€μ…μ΄ λ κ²ƒμ΄κ³ , Rμ€ Response λ¥Ό μ§€μ •ν–λ‹¤.

`export interface NestInterceptor<T = any, R = any> {...}`
β‡’ `export class TransformInterceptor<T> implements NestInterceptor<T, Response<T>> {...}`

Responseλ” μ”κµ¬μ‚¬ν•­μ— λ§κ² μ •μν• νƒ€μ…, μ¦‰ data μ†μ„±μ„ κ°€μ§€λ” κ°μ²΄κ°€ λλ„λ΅ κ°•μ ν•λ‹¤.

μ΄μ  TransformInterceptorλ¥Ό μ „μ—­μΌλ΅ μ μ©ν•΄λ³΄μ.

useGlobalInterceptorsμ— μ½¤λ§λ΅ μΈν„°μ…‰ν„° κ°μ²΄λ¥Ό μ¶”κ°€ν•λ©΄ λλ‹¤.

```tsx
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { LoggingInterceptor } from './logging.interceptor';
import { TransformInterceptor } from './transform.interceptor';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  app.useGlobalInterceptors(
    new LoggingInterceptor(),
    new TransformInterceptor(),
  );
  await app.listen(3000);
}
bootstrap();
```

μ”μ²­μ„ λ³΄λ‚΄μ„ κ²°κ³Όλ¥Ό λ³΄λ©΄ 

```bash
$ curl http://localhost:3000/users
{
	"data":"This action returns all users"
}
```

μ„λ²„ μ½μ†”μ—μ„ LoggingInterceptorμ λ΅κ·Έλ„ μ λ‚¨λ”μ§€ ν™•μΈ

μ΄μ  λΌμ°νΈ ν•Έλ“¤λ§ λ„μ¤‘ λμ Έμ§„ μμ™Έλ¥Ό μ΅μ•„μ„ λ³€ν™ν•΄λ³΄λ” μλ¥Ό λ³΄μ.

λ°μƒν• λ¨λ“  μ—λ¬λ¥Ό μ΅μ•„μ„ 502 Bad Gatewayλ΅ λ³€κ²½ν•λ” μλ¥Ό λ§λ“¤μ–΄λ³΄κ² λ‹¤.

μΆ‹μ€ μλ” μ•„λ‹λ‹¤. μμ™Έλ¥Ό λ³€ν™ν•λ” κ²ƒμ€ μμ™Έν•„ν„°μ—μ„ λ‹¤λ£¨λ” κ²ƒμ΄ λ” λ‚«μ§€λ§ μΈν„°μ…‰ν„°λ¥Ό μ΄μ©ν•΄μ„λ„ κ°€λ¥ν•λ‹¤λ” κ²ƒ μ •λ„λ” μ•μ•„λ‘μ.

```tsx
import { Injectable, NestInterceptor, ExecutionContext, BadGatewayException, CallHandler } from '@nestjs/common';
import { Observable, throwError } from 'rxjs';
import { catchError } from 'rxjs/operators';

@Injectable()
export class ErrorsInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    return next
      .handle()
      .pipe(
        catchError(err => throwError(() => new BadGatewayException())),
      );
  }
}
```

μ΄λ²μ—λ” μ „μ—­μΌλ΅ μ μ©ν•μ§€ μ•κ³  λΌμ°νΈ ν•Έλ“¤λ¬μ— GET /users/:id μ—”λ“ν¬μΈνΈμ—λ§ μ μ©ν•΄λ³΄μ.

κ°•μ λ΅ 500 μ—λ¬λ¥Ό μΌμΌν‚¤λ„λ΅ ν–λ‹¤. 

```tsx
//users.controller.ts(ch13-interceptor)
...
@Controller('users')
export class UsersController {
	...
	@UseInterceptors(ErrorsInterceptor)
  @Get(':id')
  findOne(@Param('id') id: string) {
    throw new InternalServerErrorException();
  }
	...
}
```

ν•΄λ‹Ή μ—”λ“ν¬μΈνΈλ΅ μ”μ²­μ„ ν•΄λ³΄λ©΄ λ‹¤μκ³Ό κ°™μ΄ 500 μ—λ¬κ°€ 502λ΅ λ°”λ€μ–΄ λ‚κ°€λ” κ²ƒμ„ λ³Ό μ μλ‹¤. 

```bash
$ curl http://localhost:3000/users/1
{
	"statusCode":502,
	"message":"Bad Gateway"
}
```

## 13.3 μ μ € μ„λΉ„μ¤μ— μΈν„°μ…‰ν„° μ μ©ν•κΈ°

[13.3 μ μ € μ„λΉ„μ¤μ— μΈν„°μ…‰ν„° μ μ©ν•κΈ°](https://www.notion.so/13-3-810b9bb9193f4f7db78c11b927e5ffba?pvs=21)
